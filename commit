#!/Users/kfir/.virtualenvs/ai-commit-env/bin/python

import os
import subprocess
import sys
import tempfile
from openai import AzureOpenAI
from rich.console import Console
from rich.panel import Panel
from rich.prompt import Prompt, Confirm

console = Console()

def run_command(command):
    """Executes a shell command and returns the output."""
    try:
        result = subprocess.run(
            command,
            shell=True,
            check=True,
            capture_output=True,
            text=True
        )
        return result.stdout.strip()
    except subprocess.CalledProcessError as e:
        return ""

def stage_all_changes():
    """Stages all changes (tracked and untracked) automatically."""
    console.print("[yellow]Staging all detected changes (git add .)...[/yellow]")
    run_command("git add .")
    
    # Verify something is actually staged
    staged = run_command("git diff --cached --name-only")
    if not staged:
        console.print("[bold red]No changes found to commit. Aborting.[/bold red]")
        sys.exit(0)

def get_staged_diff():
    """Retrieves the staged git diff, truncated if necessary."""
    # --unified=1 gives a bit of context for the AI
    raw_diff = run_command("git diff --cached --unified=1 --no-color")
    
    max_chars = 15000 
    if len(raw_diff) > max_chars:
        return raw_diff[:max_chars] + "\n... (diff truncated)"
    return raw_diff

def generate_commit_message(client, deployment_name, diff):
    """Generates a commit message using the Azure OpenAI API."""
    with console.status(f"[bold green]Calling Azure OpenAI ({deployment_name})...[/bold green]"):
        try:
            system_prompt = (
                "You are a senior software engineer. Generate a Conventional Commit message based on the provided git diff."
                "\nStructure:"
                "\n1. <type>(<scope>): <subject> (Max 50 chars, imperative mood)"
                "\n2. <BLANK LINE>"
                "\n3. Body: Bullet points (-) explaining *why* and *what* changed. Wrap lines at 72 chars."
                "\n\nRules:"
                "\n- Use types: feat, fix, docs, style, refactor, test, chore."
                "\n- Do NOT include 'Here is the commit message' or code blocks."
                "\n- Just return the raw commit message text."
            )
            
            user_prompt = f"Git Diff to analyze:\n\n{diff}"

            response = client.chat.completions.create(
                model=deployment_name, 
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_prompt}
                ],
                max_completion_tokens=5000
            )
            
            return response.choices[0].message.content.strip()
        
        except Exception as e:
            console.print(f"[bold red]Azure OpenAI API request failed:[/bold red]")
            console.print(f"Error Message: {str(e)}")
            
            # --- Check for full API response body ---
            if hasattr(e, 'body') and e.body is not None:
                console.print("\n[bold yellow]--- Full API Response / Error Details ---[/bold yellow]")
                # Rich will automatically pretty-print dictionaries
                console.print(e.body)
            # ----------------------------------------
            
            sys.exit(1)

def edit_message_in_editor(initial_message):
    """Opens the default editor with the message pre-filled for editing."""
    editor = os.environ.get('EDITOR', 'vim') # Defaults to vim if $EDITOR is not set
    
    with tempfile.NamedTemporaryFile(suffix=".txt", mode='w+', delete=False) as tf:
        tf.write(initial_message)
        tf_path = tf.name

    try:
        # Open the editor
        subprocess.call([editor, tf_path])
        
        # Read the file back after the user closes the editor
        with open(tf_path, 'r') as tf:
            edited_message = tf.read().strip()
            
        return edited_message
    finally:
        if os.path.exists(tf_path):
            os.unlink(tf_path)

def commit(message):
    """Creates a commit with the given message."""
    with tempfile.NamedTemporaryFile(mode='w+', delete=False, suffix=".txt") as tmp:
        tmp.write(message)
        tmp_path = tmp.name

    try:
        # We use standard 'git commit' because we already ran 'git add .' at the start
        run_command(f'git commit -F "{tmp_path}"')
        
        console.print("\n[bold green]‚úîÔ∏è  Commit created successfully![/bold green]")
        console.print(Panel(message, title="Committed Message", border_style="cyan"))

        current_branch = run_command("git rev-parse --abbrev-ref HEAD")
        if Confirm.ask(f"\n[bold]Push to origin/{current_branch}?[/bold]"):
             with console.status(f"[bold green]Pushing to origin/{current_branch}...[/bold green]"):
                push_output = run_command(f"git push origin {current_branch}")
                console.print(f"[green]Successfully pushed to origin/{current_branch}.[/green]")
    except Exception as e:
        console.print(f"[bold red]Error during commit/push:[/bold red] {e}")
    finally:
        if os.path.exists(tmp_path):
            os.unlink(tmp_path)

def main():
    """Main function to run the AI commit process."""
    console.print("[bold cyan]AI Commit Helper (Azure Edition)[/bold cyan]\n")

    # 1. Load Environment Variables
    AZURE_ENDPOINT = os.getenv("AZURE_OPENAI_ENDPOINT")
    AZURE_KEY = os.getenv("AZURE_OPENAI_KEY")
    AZURE_DEPLOYMENT = os.getenv("AZURE_OPENAI_DEPLOYMENT_NAME")

    if not all([AZURE_ENDPOINT, AZURE_KEY, AZURE_DEPLOYMENT]):
        console.print(f"[bold red]Error: Missing environment variables (ENDPOINT, KEY, or DEPLOYMENT_NAME)[/bold red]")
        sys.exit(1)

    # 2. Initialize Azure Client
    try:
        client = AzureOpenAI(
            api_key=AZURE_KEY,
            api_version="2024-10-21",
            azure_endpoint=AZURE_ENDPOINT
        )
    except Exception as e:
        console.print(f"[bold red]Failed to initialize Azure Client:[/bold red] {e}")
        sys.exit(1)

    # 3. Stage & Diff
    stage_all_changes() # <-- Changed to auto-stage everything
    diff = get_staged_diff()
    
    # 4. Generate Message
    message = generate_commit_message(client, AZURE_DEPLOYMENT, diff)

    while True:
        console.print("\n[bold]Suggested commit message:[/bold]")
        console.print(Panel(message, border_style="yellow", expand=False))

        console.print("\n[1] ‚úÖ Use this message")
        console.print("[2] üìù Edit message (opens editor)")
        console.print("[3] üîÑ Regenerate message")
        console.print("[4] ‚ùå Abort")

        choice = Prompt.ask("Choice", choices=["1", "2", "3", "4"], default="1")

        if choice == "1": # Use
            commit(message)
            break
        elif choice == "2": # Edit
            # Opens Vim/Nano/VSCode with the text pre-filled
            edited_message = edit_message_in_editor(message)
            if edited_message:
                message = edited_message # Update current message and loop back to confirmation
                # Loop continues, showing the new message for confirmation
            else:
                 console.print("[red]Message was cleared. Keeping original suggestion.[/red]")
        elif choice == "3": # Regenerate
            message = generate_commit_message(client, AZURE_DEPLOYMENT, diff)
        elif choice == "4": # Abort
            console.print("[bold red]Aborted.[/bold red]")
            sys.exit(0)

if __name__ == "__main__":
    main()